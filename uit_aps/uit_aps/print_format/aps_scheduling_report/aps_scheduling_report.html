{% set doc = doc %}
{% set results = frappe.get_all("APS Scheduling Result", filters={"scheduling_run": doc.name}, fields=["job_card", "workstation", "operation", "planned_start_time", "planned_end_time", "is_late", "is_applied"], order_by="planned_start_time asc", limit=100) %}

<style>
    .report-header {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #333;
        padding-bottom: 20px;
    }
    .report-title {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 10px;
    }
    .report-subtitle {
        font-size: 14px;
        color: #7f8c8d;
    }
    .section {
        margin-bottom: 25px;
        page-break-inside: avoid;
    }
    .section-title {
        font-size: 16px;
        font-weight: bold;
        color: #2980b9;
        border-bottom: 1px solid #3498db;
        padding-bottom: 5px;
        margin-bottom: 15px;
    }
    .info-grid {
        display: table;
        width: 100%;
        border-collapse: collapse;
    }
    .info-row {
        display: table-row;
    }
    .info-label {
        display: table-cell;
        padding: 8px 15px;
        font-weight: bold;
        background-color: #f7f9fc;
        border: 1px solid #ddd;
        width: 35%;
    }
    .info-value {
        display: table-cell;
        padding: 8px 15px;
        border: 1px solid #ddd;
    }
    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .comparison-table th {
        background-color: #2980b9;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
    }
    .comparison-table td {
        padding: 10px;
        text-align: center;
        border: 1px solid #ddd;
    }
    .comparison-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    .improvement-positive {
        color: #27ae60;
        font-weight: bold;
    }
    .improvement-negative {
        color: #e74c3c;
        font-weight: bold;
    }
    .constraint-item {
        padding: 5px 10px;
        margin: 3px 0;
        background-color: #f8f9fa;
        border-left: 3px solid #3498db;
    }
    .constraint-enabled {
        border-left-color: #27ae60;
    }
    .constraint-disabled {
        border-left-color: #95a5a6;
        color: #7f8c8d;
    }
    .summary-box {
        border: 2px solid #3498db;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
        background-color: #ebf5fb;
    }
    .summary-box.success {
        border-color: #27ae60;
        background-color: #e8f8f0;
    }
    .summary-box.warning {
        border-color: #f39c12;
        background-color: #fef9e7;
    }
    .results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
    }
    .results-table th {
        background-color: #34495e;
        color: white;
        padding: 8px;
        text-align: left;
    }
    .results-table td {
        padding: 6px 8px;
        border: 1px solid #ddd;
    }
    .results-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: bold;
    }
    .badge-success { background-color: #27ae60; color: white; }
    .badge-danger { background-color: #e74c3c; color: white; }
    .badge-warning { background-color: #f39c12; color: white; }
    .stats-grid {
        display: flex;
        flex-wrap: wrap;
        margin: 10px 0;
    }
    .stat-box {
        flex: 1;
        min-width: 120px;
        text-align: center;
        padding: 15px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
    }
    .stat-label {
        font-size: 12px;
        color: #7f8c8d;
        margin-top: 5px;
    }
    .footer-note {
        margin-top: 30px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
        font-size: 10px;
        color: #7f8c8d;
        text-align: center;
    }
</style>

<div class="report-header">
    <div class="report-title">APS Scheduling Report</div>
    <div class="report-subtitle">
        {{ doc.name }} | {{ doc.production_plan }}
    </div>
    <div class="report-subtitle">
        Generated: {{ frappe.format(frappe.utils.now_datetime(), {"fieldtype": "Datetime"}) }}
    </div>
</div>

<!-- Basic Information -->
<div class="section">
    <div class="section-title">1. Scheduling Run Information</div>
    <div class="info-grid">
        <div class="info-row">
            <div class="info-label">Production Plan</div>
            <div class="info-value">{{ doc.production_plan }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Scheduling Strategy</div>
            <div class="info-value">{{ doc.scheduling_strategy }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Scheduling Tier</div>
            <div class="info-value">{{ doc.scheduling_tier }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Run Date</div>
            <div class="info-value">{{ frappe.format(doc.run_date, {"fieldtype": "Datetime"}) }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Executed By</div>
            <div class="info-value">{{ doc.executed_by }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Run Status</div>
            <div class="info-value">{{ doc.run_status }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Solver Status</div>
            <div class="info-value">{{ doc.solver_status or "N/A" }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Solve Time</div>
            <div class="info-value">{{ "%.2f"|format(doc.solve_time_seconds or 0) }} seconds</div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="section">
    <div class="section-title">2. Summary Statistics</div>
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-value">{{ doc.total_job_cards or 0 }}</div>
            <div class="stat-label">Total Job Cards</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ doc.jobs_on_time or 0 }}</div>
            <div class="stat-label">Jobs On Time</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" style="color: {% if (doc.total_late_jobs or 0) > 0 %}#e74c3c{% else %}#27ae60{% endif %}">{{ doc.total_late_jobs or 0 }}</div>
            <div class="stat-label">Late Jobs</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ doc.makespan_minutes or 0 }}</div>
            <div class="stat-label">Makespan (mins)</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">{{ "%.1f"|format(doc.machine_utilization or 0) }}%</div>
            <div class="stat-label">Machine Utilization</div>
        </div>
    </div>
</div>

<!-- Scheduling Constraints -->
<div class="section">
    <div class="section-title">3. Scheduling Constraints Applied</div>
    <p>The following constraints were applied during the optimization process:</p>

    <div class="constraint-item {% if doc.constraint_machine_eligibility %}constraint-enabled{% else %}constraint-disabled{% endif %}">
        {% if doc.constraint_machine_eligibility %}[x]{% else %}[ ]{% endif %}
        <strong>Machine Eligibility</strong> - Each operation is scheduled only on machines capable of performing it
    </div>

    <div class="constraint-item {% if doc.constraint_precedence %}constraint-enabled{% else %}constraint-disabled{% endif %}">
        {% if doc.constraint_precedence %}[x]{% else %}[ ]{% endif %}
        <strong>Operation Precedence</strong> - Operations within the same Work Order follow the defined sequence
    </div>

    <div class="constraint-item {% if doc.constraint_no_overlap %}constraint-enabled{% else %}constraint-disabled{% endif %}">
        {% if doc.constraint_no_overlap %}[x]{% else %}[ ]{% endif %}
        <strong>No Overlap (Machine)</strong> - Each machine processes only one operation at a time
    </div>

    <div class="constraint-item {% if doc.constraint_working_hours %}constraint-enabled{% else %}constraint-disabled{% endif %}">
        {% if doc.constraint_working_hours %}[x]{% else %}[ ]{% endif %}
        <strong>Working Hours</strong> - Scheduling respects workstation working hours
    </div>

    <div class="constraint-item {% if doc.constraint_due_dates %}constraint-enabled{% else %}constraint-disabled{% endif %}">
        {% if doc.constraint_due_dates %}[x]{% else %}[ ]{% endif %}
        <strong>Due Date Respect</strong> - Optimization prioritizes meeting deadlines
    </div>

    <div class="constraint-item {% if doc.constraint_setup_time %}constraint-enabled{% else %}constraint-disabled{% endif %}">
        {% if doc.constraint_setup_time %}[x]{% else %}[ ]{% endif %}
        <strong>Setup Time</strong> - Setup time between operations is considered
    </div>

    {% if doc.constraints_description %}
    <div class="summary-box" style="margin-top: 15px;">
        <strong>Detailed Constraints Description:</strong>
        <pre style="white-space: pre-wrap; font-family: inherit; margin: 10px 0 0 0; font-size: 11px;">{{ doc.constraints_description }}</pre>
    </div>
    {% endif %}
</div>

<!-- Optimization Comparison -->
<div class="section">
    <div class="section-title">4. Optimization Comparison (vs FIFO Baseline)</div>
    <p>This section compares the optimized APS schedule against a simple FIFO (First-In-First-Out) baseline:</p>

    <table class="comparison-table">
        <thead>
            <tr>
                <th>Metric</th>
                <th>FIFO Baseline</th>
                <th>APS Optimized</th>
                <th>Improvement</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Makespan</strong></td>
                <td>{{ doc.baseline_makespan_minutes or 0 }} mins</td>
                <td>{{ doc.makespan_minutes or 0 }} mins</td>
                <td class="{% if (doc.improvement_makespan_percent or 0) > 0 %}improvement-positive{% else %}improvement-negative{% endif %}">
                    {% if (doc.improvement_makespan_percent or 0) > 0 %}+{% endif %}{{ "%.1f"|format(doc.improvement_makespan_percent or 0) }}%
                </td>
            </tr>
            <tr>
                <td><strong>Late Jobs</strong></td>
                <td>{{ doc.baseline_late_jobs or 0 }}</td>
                <td>{{ doc.total_late_jobs or 0 }}</td>
                <td class="{% if (doc.improvement_late_jobs_percent or 0) > 0 %}improvement-positive{% else %}improvement-negative{% endif %}">
                    {% if (doc.improvement_late_jobs_percent or 0) > 0 %}+{% endif %}{{ "%.1f"|format(doc.improvement_late_jobs_percent or 0) }}%
                </td>
            </tr>
            <tr>
                <td><strong>Total Tardiness</strong></td>
                <td>{{ doc.baseline_total_tardiness or 0 }} mins</td>
                <td>{{ doc.total_tardiness_minutes or 0 }} mins</td>
                <td class="{% if (doc.improvement_tardiness_percent or 0) > 0 %}improvement-positive{% else %}improvement-negative{% endif %}">
                    {% if (doc.improvement_tardiness_percent or 0) > 0 %}+{% endif %}{{ "%.1f"|format(doc.improvement_tardiness_percent or 0) }}%
                </td>
            </tr>
        </tbody>
    </table>

    {% if doc.comparison_summary %}
    <div class="summary-box {% if (doc.improvement_makespan_percent or 0) > 0 or (doc.improvement_late_jobs_percent or 0) > 0 %}success{% else %}warning{% endif %}" style="margin-top: 15px;">
        <strong>Optimization Summary:</strong>
        <pre style="white-space: pre-wrap; font-family: inherit; margin: 10px 0 0 0;">{{ doc.comparison_summary }}</pre>
    </div>
    {% endif %}
</div>

<!-- Solver Configuration -->
<div class="section">
    <div class="section-title">5. Solver Configuration</div>
    <div class="info-grid">
        <div class="info-row">
            <div class="info-label">Time Limit</div>
            <div class="info-value">{{ doc.time_limit_seconds or 300 }} seconds</div>
        </div>
        <div class="info-row">
            <div class="info-label">Min Gap Between Ops</div>
            <div class="info-value">{{ doc.min_gap_between_ops or 10 }} minutes</div>
        </div>
        <div class="info-row">
            <div class="info-label">Makespan Weight</div>
            <div class="info-value">{{ doc.makespan_weight or 1.0 }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Tardiness Weight</div>
            <div class="info-value">{{ doc.tardiness_weight or 10.0 }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Optimality Gap</div>
            <div class="info-value">{{ "%.2f"|format(doc.gap_percentage or 0) }}%</div>
        </div>
    </div>
</div>

<!-- Scheduling Results (First 50) -->
<div class="section">
    <div class="section-title">6. Scheduled Operations (Top {{ results|length }})</div>

    {% if results %}
    <table class="results-table">
        <thead>
            <tr>
                <th>Job Card</th>
                <th>Operation</th>
                <th>Workstation</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for r in results %}
            <tr>
                <td>{{ r.job_card }}</td>
                <td>{{ r.operation or "-" }}</td>
                <td>{{ r.workstation or "-" }}</td>
                <td>{{ frappe.format(r.planned_start_time, {"fieldtype": "Datetime"}) if r.planned_start_time else "-" }}</td>
                <td>{{ frappe.format(r.planned_end_time, {"fieldtype": "Datetime"}) if r.planned_end_time else "-" }}</td>
                <td>
                    {% if r.is_late %}
                    <span class="badge badge-danger">Late</span>
                    {% else %}
                    <span class="badge badge-success">On Time</span>
                    {% endif %}
                    {% if r.is_applied %}
                    <span class="badge badge-warning">Applied</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No scheduling results found.</p>
    {% endif %}
</div>

<!-- AI Analysis (if available) -->
{% if doc.llm_analysis_content %}
<div class="section">
    <div class="section-title">7. AI Analysis & Recommendations</div>
    <div class="info-grid">
        <div class="info-row">
            <div class="info-label">Analysis Date</div>
            <div class="info-value">{{ frappe.format(doc.llm_analysis_date, {"fieldtype": "Datetime"}) if doc.llm_analysis_date else "N/A" }}</div>
        </div>
        <div class="info-row">
            <div class="info-label">Model Used</div>
            <div class="info-value">{{ doc.llm_analysis_model or "N/A" }}</div>
        </div>
    </div>

    <div class="summary-box" style="margin-top: 15px;">
        {{ doc.llm_analysis_content | safe }}
    </div>
</div>
{% endif %}

<!-- Notes -->
{% if doc.notes %}
<div class="section">
    <div class="section-title">8. Additional Notes</div>
    <div class="summary-box">
        {{ doc.notes }}
    </div>
</div>
{% endif %}

<div class="footer-note">
    <strong>UIT APS - Advanced Production Scheduling System</strong><br>
    Report generated automatically from scheduling run {{ doc.name }}<br>
    &copy; 2025 UIT APS. All rights reserved.
</div>
